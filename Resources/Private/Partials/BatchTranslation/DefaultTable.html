<html
    xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
    xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
    xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
    data-namespace-typo3-fluid="true"
>

<f:variable name="reloadHref" value="{be:moduleLink(route:moduleName, arguments:{id:pageUid})}" />
<f:variable name="hasItems" value="{batchItemsRecursive -> f:count()}" />

<!-- Page Header -->
<div class="t3js-group-draggable-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">{pageTitle}</h1>
        <div>
            <a href="{reloadHref}" class="btn btn-default">
                <core:icon identifier="actions-refresh" />
                <f:translate key="LLL:EXT:core/Resources/Private/Language/locallang_common.xlf:refresh" default="Refresh" />
            </a>
            <f:if condition="{cacheEnabled}">
                <f:variable name="clearCacheHref" value="{be:moduleLink(route:moduleName, arguments:{id:pageUid, clearCache:1})}" />
                <a href="{clearCacheHref}" class="btn btn-warning ms-2" title="Clear Translation Cache">
                    <core:icon identifier="actions-system-cache-clear" />
                    <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.function.clearCache" default="Clear Cache" />
                </a>
            </f:if>
        </div>
    </div>

    <f:render section="SchedulerStatus" arguments="{schedulerStatus:schedulerStatus}" />

    <f:if condition="{hasItems}">
        <f:render section="BatchItemTable" arguments="{_all}" />
    </f:if>
</div>

<!-- Scheduler Status -->
<f:section name="SchedulerStatus">
    <div class="callout callout-info mb-3">
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">
                <f:if condition="{schedulerStatus.hasRun}">
                    <f:then>
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <span>
                                <core:icon identifier="actions-clock" size="small" />
                                <strong><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.lastRun" default="Last scheduler run" />:</strong>
                                {schedulerStatus.dateFormatted}
                                <f:if condition="{schedulerStatus.agoMinutes} < 120">
                                    <small class="text-body-secondary">({schedulerStatus.agoMinutes} <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.minutesAgo" default="min ago" />)</small>
                                </f:if>
                            </span>
                            <f:if condition="{schedulerStatus.processed}">
                                <span>
                                    <span class="badge badge-success">{schedulerStatus.succeeded} <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.succeeded" default="succeeded" /></span>
                                    <f:if condition="{schedulerStatus.failed}">
                                        <span class="badge badge-danger">{schedulerStatus.failed} <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.failed" default="failed" /></span>
                                    </f:if>
                                </span>
                            </f:if>
                            <f:if condition="{schedulerStatus.remainingPending}">
                                <span class="badge badge-warning">{schedulerStatus.remainingPending} <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.remaining" default="remaining" /></span>
                            </f:if>
                            <f:if condition="!{schedulerStatus.processed} && !{schedulerStatus.remainingPending}">
                                <span class="text-body-secondary"><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.nothingPending" default="Nothing was pending" /></span>
                            </f:if>
                        </div>
                    </f:then>
                    <f:else>
                        <core:icon identifier="actions-clock" size="small" />
                        <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:scheduler.neverRun" default="Scheduler has not run yet. Set up the 'autotranslate:batch:run' command in the Scheduler module." />
                    </f:else>
                </f:if>
            </div>
        </div>
    </div>
</f:section>

<!-- Batch Item Table Section -->
<f:section name="BatchItemTable">
    <div class="panel panel-default autotranslate-panel">

        <!-- Panel Header -->
        <div class="panel-heading multi-record-selection-panel">
            <div class="panel-heading-row">
                <div class="panel-heading-title">
                    <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.noselect" />
                </div>
                <div class="panel-heading-actions">
                    <button type="button"
                            class="btn btn-sm btn-default t3js-toggle-table"
                            data-bs-toggle="collapse"
                            data-bs-target="#autotranslate-task-group-list"
                            aria-expanded="true">
                        <core:icon identifier="actions-view-list-collapse" size="small" />
                    </button>
                </div>
            </div>
            <f:render partial="BatchTranslation/MultiRecordSelectionActions" arguments="{actions:actions}" />
        </div>

        <!-- Table -->
        <form data-multi-record-selection-form="task-group-list" method="post">
            <div class="panel-collapse collapse show" id="autotranslate-task-group-list" data-table="task-group-list">
                <div class="table-fit">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th data-sort-method="none">
                                    <f:render section="SelectionDropdown" />
                                </th>
                                <f:render section="TableHeaders" />
                                <th></th>
                            </tr>
                        </thead>
                        <tbody data-multi-record-selection-row-selection="true">
                            <f:for each="{batchItemsRecursive}" as="item">
                                <f:render section="BatchItemRow" arguments="{item:item, pageUid:pageUid, moduleName:moduleName}" />
                            </f:for>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="11">{hasItems} Entries</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </form>

    </div>
</f:section>

<!-- Table Headers -->
<f:section name="TableHeaders">
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.uid" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.page" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.priority" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.sys_language_uid" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.translate" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.translated" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.frequency" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.mode" /></th>
    <th><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.state" /></th>
</f:section>

<!-- Selection Dropdown -->
<f:section name="SelectionDropdown">
    <div class="btn-group dropdown">
        <button type="button"
                class="dropdown-toggle dropdown-toggle-link t3js-multi-record-selection-check-actions-toggle"
                data-bs-toggle="dropdown"
                data-bs-boundary="window"
                aria-expanded="false"
                aria-label="{f:translate(key:'LLL:EXT:core/Resources/Private/Language/locallang_core.xlf:labels.openSelectionOptions')}">
            <core:icon identifier="actions-selection" size="small" />
        </button>
        <ul class="dropdown-menu t3js-multi-record-selection-check-actions">
            <f:render section="SelectionMenuItem" arguments="{action:'check-all', icon:'actions-selection-elements-all', labelKey:'checkAll'}" />
            <f:render section="SelectionMenuItem" arguments="{action:'check-none', icon:'actions-selection-elements-none', labelKey:'uncheckAll'}" />
            <f:render section="SelectionMenuItem" arguments="{action:'toggle', icon:'actions-selection-elements-invert', labelKey:'toggleSelection'}" />
        </ul>
    </div>
</f:section>

<!-- Selection Menu Item -->
<f:section name="SelectionMenuItem">
    <li>
        <button type="button"
                class="dropdown-item"
                data-multi-record-selection-check-action="{action}"
                title="{f:translate(key:'LLL:EXT:core/Resources/Private/Language/locallang_core.xlf:labels.{labelKey}')}">
            <span class="dropdown-item-columns">
                <span class="dropdown-item-column dropdown-item-column-icon" aria-hidden="true">
                    <core:icon identifier="{icon}" size="small" />
                </span>
                <span class="dropdown-item-column dropdown-item-column-title">
                    <f:translate key="LLL:EXT:core/Resources/Private/Language/locallang_core.xlf:labels.{labelKey}" />
                </span>
            </span>
        </button>
    </li>
</f:section>

<!-- Batch Item Row -->
<f:section name="BatchItemRow">
    <f:variable name="deleteHref" value="{be:moduleLink(route:moduleName, arguments:{id:pageUid, delete:item.uid})}" />
    <f:variable name="executeHref" value="{be:moduleLink(route:moduleName, arguments:{id:pageUid, execute:item.uid})}" />
    <f:variable name="resetHref" value="{be:moduleLink(route:moduleName, arguments:{id:pageUid, reset:item.uid})}" />

    <f:variable name="rowClass">
        {f:if(condition:item.hidden, then:'t3-form-field-container-inline-hidden')}
        {f:if(condition:item.waitingForRun, then:' warning')}
        {f:if(condition:item.finishedRun, then:' success')}
        {f:if(condition:item.error, then:' danger')}
    </f:variable>

    <tr class="{rowClass}"
        title="id={item.uid}"
        data-multi-record-selection-element="true"
        data-uid="{item.uid}"
        data-execute="{item.executable}">

        <!-- Checkbox -->
        <td class="col-checkbox">
            <span class="form-check form-check-type-toggle">
                <input class="form-check-input t3js-multi-record-selection-check" type="checkbox">
            </span>
        </td>

        <!-- Data Columns -->
        <td>{item.uid}</td>
        <td class="nowrap" title="id={item.pid}">{item.pageTitle}</td>
        <td><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.priority.{item.priority}" /></td>
        <td title="id={item.sysLanguageUid}">{item.sysLanguageTitle}</td>
        <td class="col-datetime"><f:format.date format="d.m.Y - H:i">{item.translate}</f:format.date></td>
        <td class="col-datetime">
            <f:if condition="{item.translated}">
                <f:then><f:format.date format="d.m.Y - H:i">{item.translated}</f:format.date></f:then>
                <f:else><small>-</small></f:else>
            </f:if>
        </td>
        <td class="col-state" title="{item.frequencyDateInterval}">
            <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.frequency.{item.frequency}" />
        </td>
        <td class="col-state">
            <f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.mode.{item.mode}" />
        </td>

        <!-- Status Column -->
        <td class="col-min">
            <f:render section="StatusBadge" arguments="{item:item}" />
        </td>

        <!-- Actions Column -->
        <td class="nowrap col-control">
            <f:render section="ItemActions" arguments="{item:item, deleteHref:deleteHref, executeHref:executeHref, resetHref:resetHref, moduleName:moduleName, pageUid:pageUid}" />
        </td>
    </tr>
</f:section>

<!-- Status Badge -->
<f:section name="StatusBadge">
    <f:if condition="{item.error}">
        <f:then>
            <p><span class="badge badge-danger"><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.status.error" /></span></p>
            <p>{item.error -> f:format.crop(maxCharacters:10)}</p>
        </f:then>
        <f:else>
            <f:if condition="{item.finishedRun}">
                <span class="badge badge-success"><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.status.done" /></span>
            </f:if>
            <f:if condition="{item.waitingForRun}">
                <span class="badge badge-warning"><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.status.pending" /></span>
            </f:if>
            <f:if condition="{item.recurring}">
                <span class="badge badge-secondary"><f:translate key="LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.status.recurring" /></span>
            </f:if>
        </f:else>
    </f:if>
</f:section>

<!-- Item Actions -->
<f:section name="ItemActions">
    <div class="btn-group">
        <!-- Hide/Unhide -->
        <f:if condition="{item.hidden}">
            <f:then>
                <a class="btn btn-default"
                   href="{be:moduleLink(route:'tce_db', query:'data[tx_autotranslate_batch_item][{item.uid}][hidden]=0', currentUrlParameterName:'redirect')}"
                   title="{f:translate(key:'visibility.unhide')}">
                    <core:icon identifier="actions-edit-unhide" />
                </a>
            </f:then>
            <f:else>
                <a class="btn btn-default"
                   href="{be:moduleLink(route:'tce_db', query:'data[tx_autotranslate_batch_item][{item.uid}][hidden]=1', currentUrlParameterName:'redirect')}"
                   title="{f:translate(key:'visibility.hide')}">
                    <core:icon identifier="actions-edit-hide" />
                </a>
            </f:else>
        </f:if>

        <!-- Edit -->
        <be:link.editRecord
            returnUrl="{f:be.uri(route:moduleName, parameters:'{id:pageUid}')}"
            class="btn btn-default"
            table="tx_autotranslate_batch_item"
            uid="{item.uid}">
            <core:icon identifier="actions-file-edit" />
        </be:link.editRecord>

        <!-- Delete -->
        <a href="{deleteHref}"
           class="btn btn-default t3js-modal-trigger"
           data-bs-toggle="tooltip"
           data-severity="warning"
           data-title="{f:translate(key:'LLL:EXT:backend/Resources/Private/Language/locallang_alt_doc.xlf:label.confirm.delete_record.title')}"
           data-button-close-text="{f:translate(key:'LLL:EXT:core/Resources/Private/Language/locallang_common.xlf:cancel')}"
           data-bs-content="{f:translate(key:'confirm', arguments:'{0:item.uid}')}"
           data-button-ok-text="{f:translate(key:'LLL:EXT:backend/Resources/Private/Language/locallang_alt_doc.xlf:buttons.confirm.delete_record.yes')}"
           title="{f:translate(key:'delete')}">
            <core:icon identifier="actions-edit-delete" />
        </a>
    </div>

    <div class="btn-group" role="group">
        <!-- Reset -->
        <f:if condition="{item.waitingForRun} || {item.recurring}">
            <f:then>
                <span class="btn btn-default disabled"><core:icon identifier="empty-empty" /></span>
            </f:then>
            <f:else>
                <a class="btn btn-default"
                   href="{resetHref}"
                   title="{f:translate(key:'LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.function.reset')}">
                    <core:icon identifier="actions-refresh" />
                </a>
            </f:else>
        </f:if>

        <!-- Execute -->
        <f:if condition="{item.error}">
            <f:then>
                <span class="btn btn-default disabled"><core:icon identifier="empty-empty" /></span>
            </f:then>
            <f:else>
                <a class="btn btn-default"
                   href="{executeHref}"
                   title="{f:translate(key:'LLL:EXT:autotranslate/Resources/Private/Language/locallang_db.xlf:autotranslate_batch.function.translate')}">
                    <core:icon identifier="actions-play" />
                </a>
            </f:else>
        </f:if>
    </div>
</f:section>

</html>
